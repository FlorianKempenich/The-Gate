FROM nginx

# Install `inotifywait` tool (and `ps` for debugging)
RUN apt-get update && apt-get install -y \
    inotify-tools \
    procps \
    openssl \
 && apt-get clean \
 && rm -rf /var/lib/apt/lists/*

# Add scripts
RUN mkdir /scripts
ADD ./docker/on_new_cert.sh /scripts
ADD ./docker/monitor_certificates_and_start_nginx.sh /scripts
ADD ./docker/create_fake_certificates.sh /scripts






# Temp: Path of the cert
# Actually not needed, it's hardcoded in the script for now (`on_new_cert.sh` & `./create_fake_certificates.sh`)
ARG CERT_PATH=/https/letsencrypt/live/professionalbeginner.com




# Add `nginx` config:
# - Base configuration
# - Services configuration
WORKDIR /etc/nginx/
RUN rm ./nginx.conf
ADD ./nginx.conf .
ADD ./services.base.conf .
ADD ./services.conf .

# Start
WORKDIR /scripts
CMD ["./monitor_certificates_and_start_nginx.sh"]
